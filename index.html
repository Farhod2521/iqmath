<script>
  const modal = document.getElementById('confirmationModal');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const triggerModalBtn = document.getElementById('triggerModalBtn');  // Bu tugma testni yakunlash uchun

  const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzM3Mjg0MDE0LCJpYXQiOjE3MzcyODM0MTQsImp0aSI6IjIzMGU2YzY4ZjUxNTRlYzRiMGJjZWViMWE2OWIzYmFlIiwidXNlcl9pZCI6OCwic3R1ZGVudF9pZCI6M30.6kIfXcDlwR1j8NTUSkO27XAhZohFY98hUNlKo8ooORc";

  const headers = {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
  };

  confirmBtn.addEventListener('click', function () {
      alert('Test yakunlandi!');
      hideModal();
      
      // Fetch saved answers from localStorage
      const savedAnswers = JSON.parse(localStorage.getItem('answers')) || [];
      
      // Prepare data for posting
      const data = {
          "answers": Object.keys(savedAnswers).map(index => ({
              "quiz_id": parseInt(index) + 1,  // Adjust to match the quiz ID format
              "answer": savedAnswers[index]
          })),
          "random_answers": [],  // Add random_answers if you have that data
          "test_time": 30  // If you have the test time, use it, otherwise remove
      };

      // Post the data to the API
      fetch('http://127.0.0.1:8000/api/v1/quiz/submit-quiz-result/', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
          console.log('Success:', result);
      })
      .catch(error => {
          console.error('Error:', error);
      });
  });

  cancelBtn.addEventListener('click', function () {
      hideModal();
  });

  window.addEventListener("beforeunload", function (e) {
      e.preventDefault();
      e.returnValue = "";
      showModal();
  });

  triggerModalBtn.addEventListener('click', function () {
      showModal();
  });

  window.addEventListener('click', function (event) {
      if (event.target === modal) {
          hideModal();
      }
  });

  function showModal() {
      modal.style.display = 'flex';
  }

  function hideModal() {
      modal.style.display = 'none';
  }

  // Fetch and render quiz questions
  async function fetchQuestions() {
      const response = await fetch('http://127.0.0.1:8000/api/v1/quiz/quizzes/1/');
      const data = await response.json();

      const questionsContainer = document.getElementById('questions-container');
      const testNumbersContainer = document.querySelector('.test-numbers');

      data.forEach((item, index) => {
          const questionCard = document.createElement('div');
          questionCard.className = 'card question-card';
          questionCard.innerHTML = `
              <div class="card-body">
                  <h5 class="card-title">Savol ${index + 1}: ${item.question}</h5>
                  <div class="answer-option" data-id="A">${item.A}</div>
                  <div class="answer-option" data-id="B">${item.B}</div>
                  <div class="answer-option" data-id="C">${item.C}</div>
                  <div class="answer-option" data-id="D">${item.D}</div>
              </div>
          `;
          questionsContainer.appendChild(questionCard);

          const testNumber = document.createElement('div');
          testNumber.className = 'test-number';
          testNumber.textContent = index + 1;
          testNumbersContainer.appendChild(testNumber);
      });

      document.querySelectorAll('.answer-option').forEach(option => {
          option.addEventListener('click', function () {
              const siblings = this.parentElement.querySelectorAll('.answer-option');
              siblings.forEach(sib => sib.classList.remove('selected'));
              this.classList.add('selected');

              const questionIndex = Array.from(questionsContainer.children).indexOf(this.closest('.question-card'));
              const selectedAnswer = this.dataset.id;
              let answers = JSON.parse(localStorage.getItem('answers')) || {};
              answers[questionIndex] = selectedAnswer;
              localStorage.setItem('answers', JSON.stringify(answers));

              const testNumbers = document.querySelectorAll('.test-number');
              testNumbers[questionIndex].classList.add('completed');
          });
      });

      const savedAnswers = JSON.parse(localStorage.getItem('answers')) || {};
      document.querySelectorAll('.question-card').forEach((card, index) => {
          const savedAnswer = savedAnswers[index];
          if (savedAnswer) {
              const selectedOption = card.querySelector(`.answer-option[data-id="${savedAnswer}"]`);
              selectedOption.classList.add('selected');
              const testNumbers = document.querySelectorAll('.test-number');
              testNumbers[index].classList.add('completed');
          }
      });
  }
 // Savollarni yangilab olish, saqlangan javoblarni qo'shish
        const savedAnswers = JSON.parse(localStorage.getItem('answers')) || {};
        document.querySelectorAll('.question-card').forEach((card, index) => {
            const savedAnswer = savedAnswers[index];
            if (savedAnswer) {
                const selectedOption = card.querySelector(`.answer-option[data-id="${savedAnswer}"]`);
                selectedOption.classList.add('selected');
                const testNumbers = document.querySelectorAll('.test-number');
                testNumbers[index].classList.add('completed');
            }
        });
    

    // 2. Timerni sozlash
    function setupTimer() {
        const timerElement = document.querySelector('.timer');
        let startTime = localStorage.getItem('startTime');
        const totalDuration = 3600; // 60 daqiqa (sekundlarda)

        if (!startTime) {
            startTime = Math.floor(Date.now() / 1000);
            localStorage.setItem('startTime', startTime);
        }

        const chart = new ApexCharts(document.querySelector('#chart-radial-basic'), {
            series: [100],
            chart: {
                height: 200,
                type: 'radialBar'
            },
            colors: ['#615dff'],
            plotOptions: {
                radialBar: {
                    hollow: { size: '70%' },
                    dataLabels: {
                        name: { show: false },
                        value: {
                            fontSize: '20px',
                            formatter: function () {
                                const remainingTime = totalDuration - (Math.floor(Date.now() / 1000) - startTime);
                                const minutes = String(Math.floor(remainingTime / 60)).padStart(2, '0');
                                const seconds = String(remainingTime % 60).padStart(2, '0');
                                return `${minutes}:${seconds}`;
                            },
                            color: '#000'
                        }
                    }
                }
            }
        });
        chart.render();

        const timerInterval = setInterval(() => {
            const remainingTime = totalDuration - (Math.floor(Date.now() / 1000) - startTime);
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
            } else {
                const progress = (remainingTime / totalDuration) * 100;
                chart.updateSeries([progress]);
            }
        }, 1000);
    }

  document.addEventListener('DOMContentLoaded', () => {
      fetchQuestions();
  });
</script>