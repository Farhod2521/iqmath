{% extends "base_teacher.html" %}
{% load static %}
{% block content %}
   



<div class="modal fade" id="samedata-modal" tabindex="-1" aria-labelledby="exampleModalLabel1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex align-items-center">
                <h4 class="modal-title" id="exampleModalLabel1">Xabar matnni kiriting</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                
                    <div class="mb-3">
                        <label for="message-text" class="">Matn:</label>
                        <textarea class="form-control" id="message-text1"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                
                <button type="button" class="btn btn-success">Yuborish</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="vertical-center-modal" tabindex="-1" aria-labelledby="vertical-center-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h4 class="modal-title" id="myLargeModalLabel">
            O'quvchini qo'shish
          </h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table id="file_export_add"  class="table w-100 table-striped table-bordered display text-nowrap">
         
                  <thead>
                    <!-- start row -->
                    <tr>
                        <th>№</th>
                        <th>F.I.SH</th>
                        <th>Viloyat</th>
                        <th>Tug'ilgan kuni</th>
                        <th>Telefon raqam</th>
                        <th>Jami balli</th>
                        <th>Nechtasini topgan</th>
                        <th>Vaqt</th>
                        <th>Qo'shish</th>
                    </tr>
                    <!-- end row -->
                  </thead>
                  <tbody>
               
             
               
             
                  </tbody>
          
                </table>
              </div>
        </div>
      
      </div>
    </div>
  </div>

  <div class="modal fade" id="chetlashtirish" tabindex="-1" aria-labelledby="chetlashtirish" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h4 class="modal-title" id="myLargeModalLabel">
           O'quvchini Chetlashtirish
          </h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table  id="file_export_delete" class="table w-100 table-striped table-bordered display text-nowrap">
         
                  <thead>
                    <!-- start row -->
                    <tr>
                        <th>№</th>
                        <th>F.I.SH</th>
                        <th>Viloyat</th>
                        <th>Tug'ilgan kuni</th>
                        <th>Telefon raqam</th>
                        <th>Jami balli</th>
                        <th>Nechtasini topgan</th>
                        <th>Vaqt</th>
                        <th>Chetlashtirish</th>
                    </tr>
                    <!-- end row -->
                  </thead>
                  <tbody>
               
                 
               
             
                  </tbody>
          
                </table>
              </div>
        </div>
      
      </div>
    </div>
  </div>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"><br><br><br>
<div class="container12-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- start Tab with Flex Utilities -->
            <div class="card">
              <div class="card-body">
                <!-- Nav tabs -->
                <ul class="nav nav-pills flex-column flex-sm-row mt-4" role="tablist">
                  <li class="nav-item flex-sm-fill text-sm-center">
                    <a class="nav-link active" data-bs-toggle="tab" href="#navpill-11" role="tab">
                      <span>Barcha O'quvchilar</span>
                    </a>
                  </li>
                  <li class="nav-item flex-sm-fill text-sm-center">
                    <a class="nav-link" data-bs-toggle="tab" href="#navpill-22" role="tab">
                      <span>Imtihondan o'tgan o'quvchilar</span>
                    </a>
                  </li>
               
                </ul>
                <!-- Tab panes -->
                <div class="tab-content border mt-2">
                  <div class="tab-pane active p-3" id="navpill-11" role="tabpanel">
                    <div class="row">
                        <div class="card">
                            <div class="card-body">
                            
                              <div class="table-responsive">
                                <table id="file_export" class="table w-100 table-striped table-bordered display text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>№</th>
                                            <th>F.I.SH</th>
                                            <th>Viloyat</th>
                                            <th>Tug'ilgan kuni</th>
                                            <th>Telefon raqam</th>
                                            <th>Jami balli</th>
                                            <th>Nechtasini topgan</th>
                                            <th>Vaqt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be inserted here dynamically -->
                                    </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                    </div>
                  </div>
                  <div class="tab-pane p-3" id="navpill-22" role="tabpanel">
                    <div class="row">
                      
                            <div class="card-body">
                            
                              <div class="table-responsive">
                                <table id="file_export_telegram" class="table w-100 table-striped table-bordered display text-nowrap">
                         
                                  <thead>
                                    <!-- start row -->
                                    <tr>
                                        <th>№</th>
                                        <th>F.I.SH</th>
                                        <th>Viloyat</th>
                                        <th>Tug'ilgan kuni</th>
                                        <th>Telefon raqam</th>
                                        <th>Jami balli</th>
                                        <th>Nechtasini topgan</th>
                                        <th>Vaqt</th>
                                    </tr>
                                    <!-- end row -->
                                  </thead>
                          
                                </table>
                              </div>
                       
                          </div>
           
                    </div>
                  </div>
           
                </div>
              </div>
            </div>
            <!-- end Tab with Flex Utilities -->
          </div>
    </div>
</div>

  </div>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    
    <script>



    // API URL for "result_pass_exam"
    const pass_exam_url = "https://jetmind.uz/api/v1/quiz/result_pass_exam/";

    // Fetch data from API and populate the table
    fetch(pass_exam_url)
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector("#file_export_telegram tbody");
            
            // Tozalash va qayta yuklash uchun DataTable'ni yo'q qilish
            if ($.fn.DataTable.isDataTable('#file_export_telegram')) {
                $('#file_export_telegram').DataTable().clear().destroy();
            }

            // Ma'lumotlarni qo'shish
            data.forEach((item, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>  <!-- Indeks raqamini qo'shish -->
                    <td>${item.full_name}</td>
                    <td>${item.region}</td>
                    <td>${item.brithday}</td>
                    <td>${item.phone}</td>
                    <td>${item.score}</td>
                    <td>${item.correct_answers} / ${item.total_questions}</td>
                    <td>${item.test_time} min</td>
                `;
                tableBody.appendChild(row);
            });

            // DataTable-ni qayta ishga tushirish
            $('#file_export_telegram').DataTable({
                dom: "Bfrtip",
                buttons: [
                    { extend: "excel", className: "btn btn-success" },
                    {
                        text: "Xabar yuborish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#samedata-modal').modal('show');
                        }
                    },                     
                    {
                        text: "O'quvchi qo'shish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#vertical-center-modal').modal('show');
                        }
                    },
                    {
                        text: "O'quvchi chetlashtirish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#chetlashtirish').modal('show');
                        }
                    }
                ],
                pageLength: 10
            });
        })
        .catch(error => console.error("Error fetching data:", error));

    // API URL for "result_all"
    const apiUrl = "https://jetmind.uz/api/v1/quiz/result_all/";

    // Fetch data from API and populate the table
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector("#file_export tbody");
            
            // Tozalash va qayta yuklash uchun DataTable'ni yo'q qilish
            if ($.fn.DataTable.isDataTable('#file_export')) {
                $('#file_export').DataTable().clear().destroy();
            }

            // Ma'lumotlarni qo'shish
            data.forEach((item, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${index + 1}</td>  <!-- Indeks raqamini qo'shish -->
                        <td>${item.full_name}</td>
                        <td>${item.region}</td>
                        <td>${item.brithday}</td>
                        <td>${item.phone}</td>
                        <td>${item.score}</td>
                        <td>${item.correct_answers} / ${item.total_questions}</td>
                        <td>${item.test_time} min</td>
                    `;
                    tableBody.appendChild(row);
                });

            // DataTable-ni qayta ishga tushirish
            $('#file_export').DataTable({
                dom: "Bfrtip",
                buttons: [
                    { extend: "excel", className: "btn btn-success" }
                ],
                pageLength: 10,
                destroy: true // Eski DataTable'ni tozalash
            });
        })
        .catch(error => console.error("Error fetching data:", error));








        ////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////
        ////////////
        const apiUrl_add = "https://jetmind.uz/api/v1/quiz/result_add_student/";
const apiUrl_pass_exam = "https://jetmind.uz/api/v1/quiz/result_pass_exam_status/";

fetch(apiUrl_add)
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector("#file_export_add tbody");

        // Tozalash va qayta yuklash uchun DataTable'ni yo'q qilish
        if ($.fn.DataTable.isDataTable('#file_export_add')) {
            $('#file_export_add').DataTable().clear().destroy();
        }

        // Ma'lumotlarni qo'shish
        data.forEach((item, index) => {
            const row = document.createElement("tr");
            row.setAttribute("data-id", item.id);  // Qator uchun noyob ID berish

            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.full_name}</td>
                <td>${item.region}</td>
                <td>${item.brithday}</td>
                <td>${item.phone}</td>
                <td>${item.score}</td>
                <td>${item.correct_answers} / ${item.total_questions}</td>
                <td>${item.test_time} min</td>
                <td>
                    <button class="btn btn-primary" data-id="${item.id}">
                        <i class="ti ti-plus"></i> 
                    </button> 
                </td>
            `;
            tableBody.appendChild(row);

            // Tugma bosilganda API ga so'rov yuborish
            row.querySelector("button").addEventListener("click", function() {
                const resultId = item.id;  // Tugmadoan id olish
                const button = this;  // Tugma elementini olish
                button.disabled = true;  // Tugmani bloklash (so'rov yuborilmoqda)

                // Loading holatini ko'rsatish
                const loadingIcon = document.createElement("i");
                loadingIcon.classList.add("ti", "ti-loader", "ti-spin");  // Loading ikonkasi
                button.innerHTML = "";  // Tugmani tozalash
                button.appendChild(loadingIcon);

                fetch(apiUrl_pass_exam, {
                    method: 'PATCH',  // PATCH metodini ishlatish
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        result_id: resultId,  // resultId ni yuborish
                        status_exam: true
                    })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();  // Javobni qaytaradi
                    } else {
                        console.error('Error with PATCH request:', response.statusText);
                    }
                })
                .then(responseData => {
                    if (responseData && responseData.success) {
                        // Tugmadagi ikonani yangilash
                        button.innerHTML = '<i class="ti ti-correct"></i>';  // Ikonani yangilash

                        // Tugma uchun xabar chiqarish
                        button.classList.add("btn-success");  // Yashil tugma holati

                        // 2 sekunddan so'ng tugmani yana asl holatiga qaytarish
                        setTimeout(() => {
                            button.disabled = false;
                            button.innerHTML = '<i class="ti ti-plus"></i>';  // Asl ikonka holatiga qaytarish
                            button.classList.remove("btn-success");
                        }, 2000);

                    } else {
                        console.log("Failed to update exam status:", responseData);
                    }
                })
                .catch(error => {
                    console.error("Error in PATCH request:", error);
                    button.disabled = false;
                    button.innerHTML = '<i class="ti ti-plus"></i>';  // Tugmani asl holatiga qaytarish
                });
            });
        });

        // DataTable-ni qayta ishga tushirish
        $('#file_export_add').DataTable({
            pageLength: 10,
        });
    })
    .catch(error => console.error("Error fetching data:", error));

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const pass_exam_delete = "https://jetmind.uz/api/v1/quiz/result_pass_exam/";

fetch(pass_exam_delete)
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector("#file_export_delete tbody");

        // Tozalash va qayta yuklash uchun DataTable'ni yo'q qilish
        if ($.fn.DataTable.isDataTable('#file_export_delete')) {
            $('#file_export_delete').DataTable().clear().destroy();
        }

        // Ma'lumotlarni qo'shish
        data.forEach((item, index) => {
            const row = document.createElement("tr");
            row.setAttribute("data-id", item.id);  // Qator uchun noyob ID berish

            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.full_name}</td>
                <td>${item.region}</td>
                <td>${item.brithday}</td>
                <td>${item.phone}</td>
                <td>${item.score}</td>
                <td>${item.correct_answers} / ${item.total_questions}</td>
                <td>${item.test_time} min</td>
                <td>
                    <button class="btn btn-outline-danger" data-id="${item.id}">
                        <i class="ti ti-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);

            // Tugma bosilganda API ga so'rov yuborish
            row.querySelector("button").addEventListener("click", function() {
                const resultId = item.id;  // Tugmadoan id olish
                const button = this;  // Tugma elementini olish
                button.disabled = true;  // Tugmani bloklash (so'rov yuborilmoqda)

                // Loading holatini ko'rsatish
                const loadingIcon = document.createElement("i");
                loadingIcon.classList.add("ti", "ti-loader", "ti-spin");  // Loading ikonkasi
                button.innerHTML = "";  // Tugmani tozalash
                button.appendChild(loadingIcon);

                fetch(apiUrl_pass_exam, {
                    method: 'PATCH',  // PATCH metodini ishlatish
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        result_id: resultId,  // resultId ni yuborish
                        status_exam: false
                    })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();  // Javobni qaytaradi
                    } else {
                        console.error('Error with PATCH request:', response.statusText);
                    }
                })
                .then(responseData => {
                    if (responseData && responseData.success) {
                        // Tugmadagi ikonani yangilash
                        button.innerHTML = '<i class="ti ti-check"></i>';  // Ikonani yangilash

                        // Tugma uchun xabar chiqarish
                        button.classList.add("btn-success");  // Yashil tugma holati

                        // 2 sekunddan so'ng tugmani yana asl holatiga qaytarish
                        setTimeout(() => {
                            button.disabled = false;
                            button.innerHTML = '<i class="ti ti-trash"></i>';  // Asl ikonka holatiga qaytarish
                            button.classList.remove("btn-success");
                        }, 2000);

                    } else {
                        console.log("Failed to update exam status:", responseData);
                    }
                })
                .catch(error => {
                    console.error("Error in PATCH request:", error);
                    button.disabled = false;
                    button.innerHTML = '<i class="ti ti-trash"></i>';  // Tugmani asl holatiga qaytarish
                });
            });
        });

        // DataTable-ni qayta ishga tushirish
        $('#file_export_delete').DataTable({
            pageLength: 10,
        });
    })
    .catch(error => console.error("Error fetching data:", error));

        $(document).ready(function () {
            $('#file_export_telegram').DataTable({
                dom: "Bfrtip",
                buttons: [
                    { extend: "excel", className: "btn btn-success" },
                    {
                        text: "Xabar yuborish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#samedata-modal').modal('show');
                        }
                    },                     
                    {
                        text: "O'quvchi qo'shish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#vertical-center-modal').modal('show');
                        }
                    },
                    {
                        text: "O'quvchi chetlashtirish", // Tugma matni
                        className: "btn btn-outline-success",
                        action: function () {
                            // Modalni ko'rsatish
                            $('#chetlashtirish').modal('show');
                        }
                    }
                ],
                pageLength: 10
            });
        });
        $(document).ready(function () {
            $('#file_export').DataTable().destroy()({
                dom: "Bfrtip",
                buttons: [
                    { extend: "excel", className: "btn btn-success" }
                ],
                pageLength: 10
            });
        });
    </script>
{% endblock content %}


